(function(){function RgbQuant(t){t=t||{};this.method=t.method||2;this.t=t.t||256;this.i=t.i||4096;this.h=t.h||.01;this.u=t.u||.005;this.o=t.o||10;this.v=t.v||10;this.l=t.l||10;this.g=t.g||0;this.m=this.g?new HueStats(this.o,this.g):null;this.p=t.p||[64,64];this.M=t.M||2;this.k=false;this.A=t.A||null;this.S=t.S||false;this.R=t.R||0;this.U={};this.H=t.palette?t.palette.slice(0):[];this.G=[];this.C={};this.D={};this.I=t.I!==false;this.O=t.O||10;this.P=t.P||this.H.length==0;this.j=t.j=="manhattan"?distManhattan:distEuclidean;if(this.H.length>0){var a=this;this.H.forEach(function(t,i){var r=(255<<24|t[2]<<16|t[1]<<8|t[0])>>>0;a.G[i]=r;a.C[r]=i;a.D[r]=t})}}RgbQuant.prototype.sample=function sample(t,i){if(this.k)throw"Cannot sample additional images, palette already assembled.";var r=getImageData(t,i);switch(this.method){case 1:this.B(r.F);break;case 2:this.L(r.F,r.width);break}};RgbQuant.prototype.reduce=function reduce(t,i,r,a){if(!this.k)this.T();r=r||this.A;a=typeof a!="undefined"?a:this.S;i=i||1;if(r)var n=this.q(t,r,a);else{var s=getImageData(t),e=s.F,h=e.length,n=new Uint32Array(h);for(var u=0;u<h;u++){var f=e[u];n[u]=this.K(f)}}if(i==1)return new Uint8Array(n.buffer);if(i==2){var o=[],h=n.length;for(var u=0;u<h;u++){var f=n[u];o[u]=this.C[f]}return o}};RgbQuant.prototype.q=function(t,i,r){var a={N:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],J:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],V:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],W:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]],X:[[7/48,1,0],[5/48,2,0],[3/48,-2,1],[5/48,-1,1],[7/48,0,1],[5/48,1,1],[3/48,2,1],[1/48,-2,2],[3/48,-1,2],[5/48,0,2],[3/48,1,2],[1/48,2,2]],Y:[[8/32,1,0],[4/32,2,0],[2/32,-2,1],[4/32,-1,1],[8/32,0,1],[4/32,1,1],[2/32,2,1]],Z:[[5/32,1,0],[3/32,2,0],[2/32,-2,1],[4/32,-1,1],[5/32,0,1],[4/32,1,1],[2/32,2,1],[2/32,-1,2],[3/32,0,2],[2/32,1,2]],$:[[4/16,1,0],[3/16,2,0],[1/16,-2,1],[2/16,-1,1],[3/16,0,1],[2/16,1,1],[1/16,2,1]],_:[[2/4,1,0],[1/4,-1,1],[1/4,0,1]]};if(!i||!a[i]){throw"Unknown dithering kernel: "+i}var n=a[i];var s=getImageData(t),e=s.F,h=s.width,u=s.height,j=e.length;var f=r?-1:1;for(var o=0;o<u;o++){if(r)f=f*-1;var v=o*h;for(var c=f==1?0:h-1,l=f==1?h:0;c!==l;c+=f){var b=v+c,g=e[b],d=g&255,m=(g&65280)>>8,y=(g&16711680)>>16;var p=this.K(g),w=p&255,M=(p&65280)>>8,k=(p&16711680)>>16;e[b]=255<<24|k<<16|M<<8|w;if(this.R){var A=this.j([d,m,y],[w,M,k]);if(A<this.R)continue}var S=d-w,R=m-M,Q=y-k;for(var x=f==1?0:n.length-1,U=f==1?n.length:0;x!==U;x+=f){var H=n[x][1]*f,G=n[x][2];var C=G*h;if(H+c>=0&&H+c<h&&G+o>=0&&G+o<u){var D=n[x][0];var I=b+(C+H);var O=e[I]&255,P=(e[I]&65280)>>8,B=(e[I]&16711680)>>16;var E=Math.max(0,Math.min(255,O+S*D)),F=Math.max(0,Math.min(255,P+R*D)),L=Math.max(0,Math.min(255,B+Q*D));e[I]=255<<24|L<<16|F<<8|E}}}}return e};RgbQuant.prototype.T=function buildPal(t){if(this.k||this.H.length>0&&this.H.length<=this.t)return;var i=this.U,r=sortedHashKeys(i,true);if(r.length==0)throw"Nothing has been sampled, palette cannot be built.";switch(this.method){case 1:var a=this.i,n=r[a-1],s=i[n];var e=r.slice(0,a);var h=a,u=r.length;while(h<u&&i[r[h]]==s)e.push(r[h++]);if(this.m)this.m.tt(e);break;case 2:var e=r;break}e=e.map(function(t){return+t});this.it(e);if(!t&&this.P)this.rt();if(this.I)this.nt(e);this.k=true};RgbQuant.prototype.palette=function palette(t,i){this.T(i);return t?this.H:new Uint8Array(new Uint32Array(this.G).buffer)};RgbQuant.prototype.st=function prunePal(t){var i;for(var r=0;r<this.H.length;r++){if(!t[r]){i=this.G[r];this.H[r]=null;this.G[r]=null;delete this.C[i]}}if(this.P){var a=[],n=[],s={};for(var r=0,e=0;r<this.H.length;r++){if(this.H[r]){i=this.G[r];a[e]=this.H[r];s[i]=e;n[e]=i;e++}}this.H=a;this.G=n;this.C=s}};RgbQuant.prototype.it=function reducePal(t){if(this.H.length>this.t){var i=t.length,r={},a=0,n,s=false;for(var e=0;e<i;e++){if(a==this.t&&!s){this.st(r);s=true}n=this.et(t[e]);if(a<this.t&&!r[n]){r[n]=true;a++}}if(!s){this.st(r);s=true}}else{var h=t.map(function(t){return[t&255,(t&65280)>>8,(t&16711680)>>16]});var i=h.length,u=i,f=this.h;if(u>this.t){while(u>this.t){var o=[];for(var e=0;e<i;e++){var v=h[e],c=t[e];if(!v)continue;for(var l=e+1;l<i;l++){var b=h[l],g=t[l];if(!b)continue;var d=this.j(v,b);if(d<f){o.push([l,b,g,d]);delete h[l];u--}}}f+=u>this.t*3?this.h:this.u}if(u<this.t){y.call(o,function(t,i){return i[3]-t[3]});var m=0;while(u<this.t){h[o[m][0]]=o[m][1];u++;m++}}}var i=h.length;for(var e=0;e<i;e++){if(!h[e])continue;this.H.push(h[e]);this.G.push(t[e]);this.C[t[e]]=this.G.length-1;this.D[t[e]]=h[e]}}};RgbQuant.prototype.B=function colorStats1D(t){var i=this.U,r=0,a,n=t.length;for(var s=0;s<n;s++){a=t[s];if((a&4278190080)>>24==0)continue;if(this.m)this.m.check(a);if(a in i)i[a]++;else i[a]=1}};RgbQuant.prototype.L=function colorStats2D(n,s){var t=this.p[0],i=this.p[1],e=t*i,r=makeBoxes(s,n.length/s,t,i),h=this.U,u=this;r.forEach(function(t){var i=Math.max(Math.round(t.w*t.ht/e)*u.M,2),r={},a;iterBox(t,s,function(t){a=n[t];if((a&4278190080)>>24==0)return;if(u.m)u.m.check(a);if(a in h)h[a]++;else if(a in r){if(++r[a]>=i)h[a]=r[a]}else r[a]=1})});if(this.m)this.m.tt(h)};RgbQuant.prototype.rt=function sortPal(){var l=this;this.G.sort(function(t,i){var r=l.C[t],a=l.C[i],n=l.H[r],s=l.H[a];var e=rgb2hsl(n[0],n[1],n[2]),h=rgb2hsl(s[0],s[1],s[2]);var u=n[0]==n[1]&&n[1]==n[2]?-1:hueGroup(e.ht,l.o);var f=s[0]==s[1]&&s[1]==s[2]?-1:hueGroup(h.ht,l.o);var o=f-u;if(o)return-o;var v=lumGroup(+h.ut.toFixed(2))-lumGroup(+e.ut.toFixed(2));if(v)return-v;var c=satGroup(+h.s.toFixed(2))-satGroup(+e.s.toFixed(2));if(c)return-c});this.G.forEach(function(t,i){l.H[i]=l.D[t];l.C[t]=i})};RgbQuant.prototype.K=function nearestColor(t){var i=this.et(t);return i===null?0:this.G[i]};RgbQuant.prototype.et=function nearestIndex(t){if((t&4278190080)>>24==0)return null;if(this.I&&""+t in this.C)return this.C[t];var i=1e3,r,a=[t&255,(t&65280)>>8,(t&16711680)>>16],n=this.H.length;for(var s=0;s<n;s++){if(!this.H[s])continue;var e=this.j(a,this.H[s]);if(e<i){i=e;r=s}}return r};RgbQuant.prototype.nt=function cacheHistogram(t){for(var i=0,r=t[i];i<t.length&&this.U[r]>=this.O;r=t[i++])this.C[r]=this.et(r)};function HueStats(t,i){this.ft=t;this.ot=i;this.vt={};for(var r=-1;r<t;r++)this.vt[r]={ct:0,cols:[]};this.lt=0}HueStats.prototype.check=function checkHue(t){if(this.lt==this.ft+1)this.check=function(){return};var i=t&255,r=(t&65280)>>8,a=(t&16711680)>>16,n=i==r&&r==a?-1:hueGroup(rgb2hsl(i,r,a).ht,this.ft),s=this.vt[n],e=this.ot;s.ct++;if(s.ct>e)return;if(s.ct==e)this.lt++;if(s.ct<=e)this.vt[n].cols.push(t)};HueStats.prototype.tt=function injectHues(i){for(var t=-1;t<this.ft;t++){if(this.vt[t].ct<=this.ot){switch(typeOf(i)){case"Array":this.vt[t].cols.forEach(function(t){if(i.indexOf(t)==-1)i.push(t)});break;case"Object":this.vt[t].cols.forEach(function(t){if(!i[t])i[t]=1;else i[t]++});break}}}};var s=.2126,e=.7152,h=.0722;function rgb2lum(t,i,r){return Math.sqrt(s*t*t+e*i*i+h*r*r)}var t=255,i=255,r=255;var u=Math.sqrt(s*t*t+e*i*i+h*r*r);function distEuclidean(t,i){var r=i[0]-t[0],a=i[1]-t[1],n=i[2]-t[2];return Math.sqrt(s*r*r+e*a*a+h*n*n)/u}var f=s*t+e*i+h*r;function distManhattan(t,i){var r=Math.abs(i[0]-t[0]),a=Math.abs(i[1]-t[1]),n=Math.abs(i[2]-t[2]);return(s*r+e*a+h*n)/f}function rgb2hsl(t,i,r){var a,n,s,e,h,u;t/=255;i/=255;r/=255;a=Math.max(t,i,r);n=Math.min(t,i,r);h=(a+n)/2;if(a==n){s=e=0}else{u=a-n;e=h>.5?u/(2-a-n):u/(a+n);switch(a){case t:s=(i-r)/u+(i<r?6:0);break;case i:s=(r-t)/u+2;break;case r:s=(t-i)/u+4;break}s/=6}return{ht:s,s:e,ut:rgb2lum(t,i,r)}}function hueGroup(t,i){var r=1/i,a=r/2;if(t>=1-a||t<=a)return 0;for(var n=1;n<i;n++){var s=n*r;if(t>=s-a&&t<=s+a)return n}}function satGroup(t){return t}function lumGroup(t){return t}function typeOf(t){return Object.prototype.toString.call(t).slice(8,-1)}var y=isArrSortStable()?Array.prototype.sort:stableSort;function stableSort(r){var t=typeOf(this[0]);if(t=="Number"||t=="String"){var a={},i=this.length,n;for(var s=0;s<i;s++){n=this[s];if(a[n]||a[n]===0)continue;a[n]=s}return this.sort(function(t,i){return r(t,i)||a[t]-a[i]})}else{var a=this.map(function(t){return t});return this.sort(function(t,i){return r(t,i)||a.indexOf(t)-a.indexOf(i)})}}function isArrSortStable(){var r="abcdefghijklmnopqrstuvwxyz";return"xyzvwtursopqmnklhijfgdeabc"==r.split("").sort(function(t,i){return~~(r.indexOf(i)/2.3)-~~(r.indexOf(t)/2.3)}).join("")}function getImageData(t,i){var r,a,n,s,e,h;switch(typeOf(t)){case"HTMLImageElement":r=document.createElement("canvas");r.width=t.naturalWidth;r.height=t.naturalHeight;a=r.getContext("2d");a.drawImage(t,0,0);case"Canvas":case"HTMLCanvasElement":r=r||t;a=a||r.getContext("2d");case"CanvasRenderingContext2D":a=a||t;r=r||a.canvas;n=a.getImageData(0,0,r.width,r.height);case"ImageData":n=n||t;i=n.width;if(typeOf(n.data)=="CanvasPixelArray")s=new Uint8Array(n.data);else s=n.data;case"Array":case"CanvasPixelArray":s=s||new Uint8Array(t);case"Uint8Array":case"Uint8ClampedArray":s=s||t;e=new Uint32Array(s.buffer);case"Uint32Array":e=e||t;s=s||new Uint8Array(e.buffer);i=i||e.length;h=e.length/i}return{bt:r,gt:a,dt:n,yt:s,F:e,width:i,height:h}}function makeBoxes(t,i,r,a){var n=~~(t/r),s=t%r,e=~~(i/a),h=i%a,u=t-s,f=i-h;var o=[];for(var v=0;v<i;v+=a)for(var c=0;c<t;c+=r)o.push({x:c,y:v,w:c==u?s:r,ht:v==f?h:a});return o}function iterBox(t,i,r){var a=t,n=a.y*i+a.x,s=(a.y+a.ht-1)*i+(a.x+a.w-1),e=0,h=i-a.w+1,u=n;do{r.call(this,u);u+=++e%a.w==0?h:1}while(u<=s)}function sortedHashKeys(r,a){var t=[];for(var i in r)t.push(i);return y.call(t,function(t,i){return a?r[i]-r[t]:r[t]-r[i]})}this.wt=RgbQuant;if(typeof module!=="undefined"&&module.exports){module.exports=RgbQuant}}).call(this);
